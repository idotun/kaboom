-- Get exchange rates for selected currencies --
WITH rate AS (
    SELECT ccy, rate
    FROM `kaboom-408215.kaboom.fx_rates_eur`
    WHERE ccy IN ('EUR', 'PLN', 'CHF')
    GROUP BY ccy, rate
)
-- Main query to retrieve data need for analysis of opportunity --
SELECT
    b.name,
    a.customercityid,
    a.currency,
    c.exponent,
    e.rate,
    COUNT(DISTINCT a.customerid) AS customers,
    COUNT(DISTINCT a.transaction_id) AS orders,
    COUNT(DISTINCT a.restaurantid) AS restaurants,
    (SUM(operation_cost)/POW(10, exponent))*e.rate AS operation_cost,
    (SUM(other_revenue + commission_revenue)/POW(10, exponent))*e.rate AS revenue
FROM
    `kaboom-408215.kaboom.transaction_dimensions` a
INNER JOIN 
    `kaboom-408215.kaboom.transaction_financials` d
ON a.transaction_id = d.transaction_id
INNER JOIN 
    `kaboom-408215.kaboom.cities` b
ON b.city_id = a.customercityid
INNER JOIN
    `kaboom-408215.kaboom.currency_details` c
ON a.currency = c.currency
INNER JOIN rate e 
ON e.ccy = a.currency
GROUP BY
    name, customercityid, currency, exponent, rate
ORDER BY 6 DESC, 7 DESC;
